# 📡커스텀 커넥터를 이용한 외부 데이터 조회

## 1. 커넥터(Connector)란?

Copilot Studio에서 **커넥터**는 외부 시스템과 통신하기 위한 **사전 정의된 API 인터페이스**입니다. Microsoft에서 기본적으로 제공하며, 다양한 SaaS 서비스와의 통합을 쉽게 구현할 수 있습니다.

- **정의**: 외부 서비스와의 통합을 위한 미리 구성된 API 연결
- **사용 예시**:
  - Outlook 일정 조회
  - SharePoint 문서 검색
  - Teams 메시지 전송
- **주요 특징**:
  - 인증 방식 내장 (OAuth2.0 등)
  - 다양한 서비스와 즉시 연결 가능
  - Power Platform과도 연동 가능

## 2. 커스텀 커넥터(Custom Connector)란?

**커스텀 커넥터**는 기본 커넥터로는 지원되지 않는 **고유한 API 또는 사내 시스템**과의 통합을 위해 사용자가 직접 정의하는 커넥터입니다.

- **정의**: 사용자 또는 조직이 직접 정의한 API 연결
- **사용 목적**:
  - 사내 시스템 연동
  - 서드파티 API 통합
  - 특수한 인증 방식 적용
- **구성 요소**:
  - API 엔드포인트
  - 인증 방식 (API Key, OAuth 등)
  - 요청/응답 스키마

## 3. 커넥터를 사용하는 경우

|사용 | 예제 시나리오 | 
|-|-|
|외부 서비스와 데이터 연동 필요| CRM에서 고객 정보 가져오기| 
|자동화된 작업 흐름 필요 | 이메일 수신 시 DB에 기록 |
| Copilot이 특정 시스템의 데이터를 기반으로 응답해야 할 때 | ERP 시스템의 재고 정보 기반 응답 |

## 4. 커넥터 사용의 효과

|효과 | 설명|
|-|-|
|🔗 시스템 간 통합다양한 SaaS 및 온프레미스 시스템과 연결 가능| ⚡ 자동화 및 생산성 향상 | 반복 작업을 자동화하여 업무 효율 증가 |
| 🧠 Copilot의 응답 지능 향상 | 실시간 데이터 기반으로 더 정확한 응답 생성 |
| 🔒 보안 및 인증 관리 | OAuth2.0, API Key 등 다양한 인증 방식 지원 |

---

## 5. 실습

지금부터 커스텀 커넥터를 생성하고 에이전트에 연결하는 실습을 해 보도록 하겠습니다. <br>

실습 시나리오는 다음과 같습니다.
- 사내 데이터를 통해 조회된 국가 코드를 기반으로 외교부에서 제공하는 국가 정보, 사건사고 데이터를 조회합니다. <br> 이후 출력 포멧에 맞추어 Agent가 내용을 정리하여 답변하도록 합니다.

외부 API 실습에는 [공공데이터포털](https://www.data.go.kr/) 에서 제공하는 데이터를 활용합니다.<br> 공공 데이터 포털은정부에서 운영하는 공공데이터 포털입니다. 회원가입 이후 필요 데이터를 무료로 이용할 수 있습니다. <br> <br>

<img width="1282" height="881" alt="image" src="https://github.com/user-attachments/assets/eae5abfc-c2f8-43e2-b667-07b8212c76e0" />


🌟실습에 사용될 데이터 정보는 다음과 같습니다.
1. [외교부_국가·지역별 경제현황](https://www.data.go.kr/data/15099538/openapi.do): ISO국가코드를 이용하여 국가·지역별 경제현황 정보를 조회 합니다.
2. [외교부_국가∙지역별 사건사고 유형](https://www.data.go.kr/data/15076236/openapi.do): ISO국가코드를 이용하여 사건 사고가 발생한 국가명, 발생년도, 사건사고 유형 및 사고 내용에 대한 상세 정보를 조회합니다.
<br>

> ⚠️주의⚠️ 이번 실습에서는 편의를 위해 미리 생성된 인증키를 통해 실습을 진행합니다. <br> 이 인증키는 실습이 끝나고 이용이 불가하기 때문에 지속적으로 이용이 필요할 경우, 공공데이터포털에서 [활용신청] 을 선택하여 개별로 API 인증키를 발급받으셔야 합니다.
<img width="1295" height="601" alt="image" src="https://github.com/user-attachments/assets/6b978583-31c0-439c-9f71-374e16c1ec78" />

---

그럼 지금부터 실습을 시작해 보도록 합니다. 이번 세션에서 활용할 공공데이터 포털 API 인증키 정보 입니다.
### <br> 🏆🏆**API Key 정보**🏆🏆 <br> 
```
🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆TBD🏆
```

먼저 **[도구]** 섹션에서 **[+도구 추가]** 를 클릭합니다.
<img width="959" height="203" alt="image" src="https://github.com/user-attachments/assets/8cc797d5-dadb-4bd5-aa94-58c47d5c9334" />
<br> <br> 
이곳 도구 선택창에서 Agent가 사용할수 있는다양한 도구(API 커넥터)를 선택할 수 있습니다. <br> 지금은 커넥터를 제공하지 않는 시스템을 호출해야 하기때문에 커스텀 커넥터를 생성해야하며, 이를 위해 우측 중간에 **[+ 새로운 도구]** 를 선택합니다.
<img width="1019" height="626" alt="image" src="https://github.com/user-attachments/assets/216a6315-6a16-432d-b3e2-3ce5148d4937" />
<br> <br>
새로운 도구 선택창에서 [사용자 지정 커넥터] 를 선택하면, [Power apps](https://make.powerapps.com/customconnectors) 창이 생성되며 리다이렉트 됩니다.
<img width="1025" height="461" alt="image" src="https://github.com/user-attachments/assets/d50677b0-136a-4645-bc31-28af8485f7b4" />
<br> <br>

Power apps 페이지에 우측 상단의 **[+ 새 사용자 지정 커넥터]** 를 선택후, **[처음부터 만들기]** 를 선택합니다.
<img width="1721" height="547" alt="image" src="https://github.com/user-attachments/assets/926c070c-b85d-48ed-a31d-8c2bdd9f9a5a" />

다음으로 커넥터 이름을 입력하고 **[계속]** 을 선택합니다.
> **⚠️주의⚠️ 반드시 영어로 작성해야 합니다.**
```
MOFA-CountryData
```
<img width="1486" height="765" alt="image" src="https://github.com/user-attachments/assets/3013ec84-fde6-457a-be92-a6223a44b21a" />
<br> <br>

커넥터의 일반정보에 **설명**과 **호스트**를 아래 값을 입력하고 다음 단계** [보안] **으로 이동합니다. (기준 URL을 그대로 둡니다.)
- 설명 <br> 
```
ISO국가코드를 이용하여 국가·지역별 경제현황 정보를 조회 합니다.
```
- 호스트 <br>
```
apis.data.go.kr
```
<img width="1357" height="930" alt="image" src="https://github.com/user-attachments/assets/725792ad-f254-4a3f-b0cd-fe7c76790cc2" />
<br> <br>

보안에서는 API의 인증형식을 지정할 수 있습니다. <br>
커넥터를 여러 사용자가 사용하고, 사용자마다 서로 다른 API키를 입력해야 하는 경우에는 **[API키]**, **[OAuth 2.0]** 등을 선택합니다. <br>
이번 세션에서는 쿼리에 API키가 함께 포함되어 호출이 되는 구조이므로 **[인증 없음]** 을 선택하고, 다음 **[정의]** 단계에서 
API키를 직접 입력토록 합니다.
<img width="1218" height="374" alt="image" src="https://github.com/user-attachments/assets/75f93606-ab0c-40e2-93c2-23a75a33cb6d" />
<br> <br>
정의 단계에서 **[+ 새동작]** 을 클릭하여, API 호출을 정의합니다. <br>
<img width="1291" height="925" alt="image" src="https://github.com/user-attachments/assets/95e2129c-0565-4f39-86a8-567149752864" />

이후 다음 정보를 입력합니다.
| | |
|-|-|
|요약|GetOverviewEconomicService|
|**설명**|국가·지역별 경제현황 정보를 제공합니다. ISO 2자리 국가코드를 이용하여 국가·지역별 경제현황 목록 조회합니다.|
|**작업ID**|GetOverviewEconomicService|
|**표시 여부**|important|
<img width="1140" height="583" alt="image" src="https://github.com/user-attachments/assets/5f622f76-f972-4646-bda7-7b47daac45f4" />

<br>

다음은 요청에서 **[+ 샘플에서 가져오기]** 를 선택하여 API 호출 쿼리를 지정합니다.
이곳에서는 실제 API가 호출될 때의 URL정보를 입려하여 API Endpoint, 쿼리를 직접 선언하지 않더라도 자동으로 파싱하여 빠르게 커넥터를 생성할 수 있도록 만들어 줍니다.
<img width="723" height="155" alt="image" src="https://github.com/user-attachments/assets/1d56a006-c977-4b11-ac30-c9b274b4a858" />

<br> <br>
좌측 패널에 다음의 값을 입력하고 [가져오기] 를 선택합니다.
- **동사**: **Get**
- **URL**: 아래 정보를 붙여넣습니다. (헤더는 공란으로 유지합니다.)
```
https://apis.data.go.kr/1262000/OverviewEconomicService/OverviewEconomicList?serviceKey=########API Key######&numOfRows=10&pageNo=1&cond[country_iso_alp2::EQ]=US
```
<img width="1291" height="704" alt="image" src="https://github.com/user-attachments/assets/e59b7508-c10b-4bdc-a147-4855cb12e432" />

<br> <br>

다음은 Request 쿼리의 정보를 수정합니다.<br>
해당 정보는 Copilot studio 에서 도구의 Input으로 관리할 수도 있으나, 편의를 위해 Power apps 아래와 같이 설정합니다.<br>
> ⚠️⚠️ **별도 언급이 없는 데이터는 기본 설정,값 그대로 유지합니다.** ⚠️⚠️

|쿼리|기본값|필요여부|표시여부|
|-|-|-|-|
|serviceKey|[API Key](https://github.com/chichoi1991/Copilot_Agent/edit/main/%EC%BB%A4%EC%8A%A4%ED%85%80%EC%97%94%EC%A7%84%20%EC%97%90%EC%9D%B4%EC%A0%84%ED%8A%B8%20%EC%8B%A4%EC%8A%B5/3.%203.%20%EC%BB%A4%EC%8A%A4%ED%85%80%20%EC%BB%A4%EB%84%A5%ED%84%B0%EB%A5%BC%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20%EC%99%B8%EB%B6%80%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EC%A1%B0%ED%9A%8C.md#-api-key-%EC%A0%95%EB%B3%B4-)를 입력합니다.|예|Internal|
|numOfRows|10|예|Internal|
|PageNo|1|예|Internal|
|cond[country_iso_alp2::EQ]|공란유지|아니요|none or important|
<br> <br> 
설정하려는 쿼리를 클리하면 각 쿼리의 변수 설정창으로 이동하게 됩니다. 
<img width="845" height="759" alt="image" src="https://github.com/user-attachments/assets/327e9c67-71e1-4212-bbad-27b42cf12508" />
<br> <br> 
값을 모두 입력하고 상단의 [<-뒤로] 를 누르면 자동으로 저장된 채로 돌아옵니다.
<img width="1286" height="1018" alt="image" src="https://github.com/user-attachments/assets/b0164eb1-a336-42a7-81fe-c339d6b65f06" />

Request 쿼리 정보 수정을 마쳤으면, 스크롤을 내려 **Reponse** 형식을 정의 합니다. <br>
여기서는 API를 호출하고 반환받은 정보를 샘플로 입력하여, 실제 API Response의 파라미터를 빠르게 정의할 수 있습니다.
Response(응답) 영역에 있는 **[Default]** 를 클릭 합니다.
<img width="873" height="246" alt="image" src="https://github.com/user-attachments/assets/23643d03-e318-400e-9a1e-0c9b46f63994" />
<br> <br> 

응답 설정에서 **[+샘플에서 가져오기]** 를 선택합니다.
<img width="1319" height="378" alt="image" src="https://github.com/user-attachments/assets/a9970768-2d42-49cc-ac5b-5ab9bfdfd8e2" />
<br> <br>

이후 헤더는 공란을 유지하고, **[본문]** 에 아래 API 응답 샘플을 붙여넣고 **[가져오기]** 를 선택합니다.
<img width="1359" height="674" alt="image" src="https://github.com/user-attachments/assets/e31e2f19-b3fe-45a9-a424-bbde9d1e751a" />
<br> <br>

가져오기가 완료되면 다음과 같이 본문의 Response 페이로드가 표시되며, 상단의** [<-뒤로]** 를 선택하여 본문으로 돌아옵니다.
<img width="1341" height="789" alt="image" src="https://github.com/user-attachments/assets/1bdbd12d-9fc4-4ade-8536-c5a2981290f1" />
<br> <br> 
마지막으로 상단의 **[커넥터 만들기]** 를 선택하여 설정한 커넥터를 생성합니다.
<br> 
생성이 완료되면 **5.테스트** 에서 실제로 API가 호출이 되는지 확인할 수 있습니다. <br> 
**[연결]** 에서 **[+새연결]** 을 선택하여 새로운 커넥터 연결을 추가합니다.
<img width="1230" height="399" alt="image" src="https://github.com/user-attachments/assets/f789e807-b913-4af2-bf87-2a83ff083838" />
<br> 
> 추가가 되면, 연결 페이지로 이동하게 됩니다. 다시 커스텀 커넥터로 이동을 하려면 좌측 패널에서 커스텀커넥터를 선택합니다. <br> 만약 커스텀 커넥터가 보이지 않는다면, **더보기** 를 선택, 이후 **[모두 살펴보기]** 를 클릭하여 검색으로 이동후, **[데이터]** 항목에 **[사용자 지정 커넥터]** 를 선택 또는 고정 후 선택하여 이동할 수 있습니다.
<img width="660" height="721" alt="image" src="https://github.com/user-attachments/assets/fe7cf46b-2d25-45bd-a87e-ca876f5efb06" />
<img width="978" height="642" alt="image" src="https://github.com/user-attachments/assets/0abce34c-c43c-41bb-a39b-1968488e7a4c" />

<br> <br>
이제 실제 API호출 테스트를 위해 사용자 지정 커넥터로 이동하여 생성하였던 MOFA-countryData 커넥터를 선택합니다.
<img width="1176" height="680" alt="image" src="https://github.com/user-attachments/assets/d83d34ac-c3f0-4dff-b1af-3d5e0682d4e4" />

<br> <br>
다음으로 우측 상단의 [편집]을 선택한 후 [5.테스트] 를 클릭하여 이동합니다.
<img width="1301" height="337" alt="image" src="https://github.com/user-attachments/assets/bdb3838e-b9d2-4563-9a6d-be5f64954359" />
<br> <br> 

테스트에는 방금 연결한 연결정보가 표시되고 있으며, 
작업에는 **cond[country_iso_alp2::EQ]** 파라미터에 대한 값을 입력 받도록 되어있습니다.
테스트를 위해 해당 값에 ```US``` 를 입력하고 **[테스트 작업]** 을 클릭합니다.
<img width="1185" height="806" alt="image" src="https://github.com/user-attachments/assets/4cab9ba1-96ce-4e86-b2cd-1b09a47ba92e" />

호출이 성공적으로 완료되면, 아래 이미지와 같이 200 응답과 함께 Body(본문)에 미국에 관련된 정보가 표시됩니다.
<img width="976" height="767" alt="image" src="https://github.com/user-attachments/assets/d533da9b-ab1b-4474-9042-eab6f29c634e" />

---


